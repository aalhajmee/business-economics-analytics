---
title: "Consumer Financial Health Index (CFHI) - Data Processing Pipeline"
author: "Financial Health Analytics Dashboard"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Overview

This document processes raw economic data to generate the **Consumer Financial Health Index (CFHI)**, a composite measure of household financial well-being in the United States.

## Methodology

The CFHI combines four key economic indicators:

1. **Savings Rate (S)**: Personal saving as % of disposable income (↑ better)
2. **Wage Growth (W)**: Year-over-year change in average hourly earnings (↑ better)
3. **Inflation (I)**: Year-over-year CPI-U change (↓ better, inverted in formula)
4. **Borrowing Rate (R)**: Federal Funds Rate (↓ better, inverted in formula)

### Formula

$$
CFHI = \frac{S^* + W^* + I^* + R^*}{4}
$$

Where each component is normalized to 0-100 scale:

- $S^* = 100 \times \frac{S - S_{min}}{S_{max} - S_{min}}$
- $W^* = 100 \times \frac{W - W_{min}}{W_{max} - W_{min}}$
- $I^* = 100 - 100 \times \frac{I - I_{min}}{I_{max} - I_{min}}$ (inverted)
- $R^* = 100 - 100 \times \frac{R - R_{min}}{R_{max} - R_{min}}$ (inverted)

The final CFHI is the simple average: $CFHI = \frac{S^* + W^* + I^* + R^*}{4}$, producing a natural 0-100 scale where 0 represents all indicators at their historical worst and 100 represents all at their historical best.

---

# Configuration

## Input Data Files

Modify these paths to use different data sources:

```{r config}
# Raw data file paths
SAVINGS_FILE <- "series_raw/savings_rate.csv"
WAGE_FILE <- "series_raw/wage_yoy.csv"
INFLATION_FILE <- "series_raw/inflation_yoy.csv"
BORROW_FILE <- "series_raw/borrow_rate.csv"

# Output file path
OUTPUT_FILE <- "cfhi_master_2000_onward.csv"
```

---

# Load Required Libraries

```{r libraries}
library(tidyverse)
library(lubridate)
library(knitr)
library(DT)
```

---

# Load Raw Data

```{r load_data}
# Load savings rate
savings_data <- read_csv(SAVINGS_FILE, show_col_types = FALSE) %>%
  mutate(date = as.Date(date)) %>%
  select(date, savings_rate)

# Load wage growth (year-over-year)
wage_data <- read_csv(WAGE_FILE, show_col_types = FALSE) %>%
  mutate(date = as.Date(date)) %>%
  select(date, wage_level, wage_yoy)

# Load inflation (year-over-year CPI-U)
inflation_data <- read_csv(INFLATION_FILE, show_col_types = FALSE) %>%
  mutate(date = as.Date(date)) %>%
  select(date, cpi_level, inflation_yoy)

# Load borrowing rate (Federal Funds Rate)
borrow_data <- read_csv(BORROW_FILE, show_col_types = FALSE) %>%
  mutate(date = as.Date(date)) %>%
  select(date, borrow_rate)

cat(sprintf("✓ Loaded %d savings observations\n", nrow(savings_data)))
cat(sprintf("✓ Loaded %d wage observations\n", nrow(wage_data)))
cat(sprintf("✓ Loaded %d inflation observations\n", nrow(inflation_data)))
cat(sprintf("✓ Loaded %d borrowing rate observations\n", nrow(borrow_data)))
```

---

# Merge Data

```{r merge_data}
# Merge all data sources by date
cfhi_data <- savings_data %>%
  full_join(wage_data, by = "date") %>%
  full_join(inflation_data, by = "date") %>%
  full_join(borrow_data, by = "date") %>%
  arrange(date) %>%
  mutate(
    year = year(date),
    month = month(date)
  )

cat(sprintf("✓ Merged dataset: %d observations from %s to %s\n", 
            nrow(cfhi_data), 
            min(cfhi_data$date), 
            max(cfhi_data$date)))

# Show first few rows
head(cfhi_data, 10) %>%
  kable(caption = "First 10 rows of merged data")
```

---

# Normalize Components

Using **full dataset** min/max for consistent normalization:

```{r normalize}
# Min-max normalization function
normalize_0_100 <- function(x) {
  x_min <- min(x, na.rm = TRUE)
  x_max <- max(x, na.rm = TRUE)
  
  if (x_max == x_min) {
    return(rep(50, length(x)))  # If no variation, return midpoint
  }
  
  return(100 * (x - x_min) / (x_max - x_min))
}

# Calculate normalized components
cfhi_data <- cfhi_data %>%
  mutate(
    # Savings: higher is better (direct normalization)
    S_star = normalize_0_100(savings_rate),
    
    # Wages: higher growth is better (direct normalization)
    W_star = normalize_0_100(wage_yoy),
    
    # Inflation: lower is better (inverted normalization)
    I_star = 100 - normalize_0_100(inflation_yoy),
    
    # Borrowing rate: lower is better (inverted normalization)
    R_star = 100 - normalize_0_100(borrow_rate)
  )

# Display normalization ranges
cat("\n=== Normalization Ranges ===\n\n")
cat(sprintf("Savings Rate:    %.2f%% to %.2f%% → 0 to 100\n", 
            min(cfhi_data$savings_rate, na.rm = TRUE),
            max(cfhi_data$savings_rate, na.rm = TRUE)))
cat(sprintf("Wage Growth:     %.2f%% to %.2f%% → 0 to 100\n", 
            min(cfhi_data$wage_yoy, na.rm = TRUE),
            max(cfhi_data$wage_yoy, na.rm = TRUE)))
cat(sprintf("Inflation:       %.2f%% to %.2f%% → 100 to 0 (inverted)\n", 
            min(cfhi_data$inflation_yoy, na.rm = TRUE),
            max(cfhi_data$inflation_yoy, na.rm = TRUE)))
cat(sprintf("Borrowing Rate:  %.2f%% to %.2f%% → 100 to 0 (inverted)\n", 
            min(cfhi_data$borrow_rate, na.rm = TRUE),
            max(cfhi_data$borrow_rate, na.rm = TRUE)))
```

---

# Calculate CFHI

```{r calculate_cfhi}
# Calculate CFHI as simple average of four normalized components
# Each component is already 0-100, so average naturally produces 0-100 scale
# CFHI = 0   means all 4 indicators at their historical worst
# CFHI = 100 means all 4 indicators at their historical best
cfhi_data <- cfhi_data %>%
  mutate(
    CFHI = (S_star + W_star + I_star + R_star) / 4
  )

cat("\n✓ CFHI calculated as simple average of 4 components\n")
cat("  CFHI = 0   → All indicators at historical worst\n")
cat("  CFHI = 100 → All indicators at historical best\n")

# Summary statistics
cat("\n=== CFHI Summary Statistics ===\n\n")
cat(sprintf("Minimum:  %.2f (date: %s)\n", 
            min(cfhi_data$CFHI, na.rm = TRUE),
            cfhi_data$date[which.min(cfhi_data$CFHI)]))
cat(sprintf("Maximum:  %.2f (date: %s)\n", 
            max(cfhi_data$CFHI, na.rm = TRUE),
            cfhi_data$date[which.max(cfhi_data$CFHI)]))
cat(sprintf("Mean:     %.2f\n", mean(cfhi_data$CFHI, na.rm = TRUE)))
cat(sprintf("Median:   %.2f\n", median(cfhi_data$CFHI, na.rm = TRUE)))
cat(sprintf("Latest:   %.2f (date: %s)\n", 
            tail(cfhi_data$CFHI[!is.na(cfhi_data$CFHI)], 1),
            tail(cfhi_data$date[!is.na(cfhi_data$CFHI)], 1)))
```

---

# Visualize CFHI

```{r plot_cfhi, fig.width=12, fig.height=6}
# Plot CFHI over time
ggplot(cfhi_data %>% filter(!is.na(CFHI)), aes(x = date, y = CFHI)) +
  geom_line(color = "#1e40af", linewidth = 1) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray50", alpha = 0.5) +
  annotate("text", x = min(cfhi_data$date, na.rm = TRUE), y = 50, 
           label = "Midpoint", vjust = -0.5, hjust = 0, color = "gray50", size = 3) +
  labs(
    title = "Consumer Financial Health Index (CFHI)",
    subtitle = "0 = Worst, 100 = Best Historical Financial Health",
    x = "Date",
    y = "CFHI (0-100)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12, color = "gray40")
  )
```

---

# Component Analysis

```{r plot_components, fig.width=12, fig.height=8}
# Prepare data for plotting
components_long <- cfhi_data %>%
  select(date, S_star, W_star, I_star, R_star) %>%
  pivot_longer(cols = c(S_star, W_star, I_star, R_star),
               names_to = "component",
               values_to = "value") %>%
  mutate(
    component = case_when(
      component == "S_star" ~ "Savings Rate",
      component == "W_star" ~ "Wage Growth",
      component == "I_star" ~ "Inflation (inverted)",
      component == "R_star" ~ "Borrowing Rate (inverted)",
      TRUE ~ component
    )
  )

# Plot all components
ggplot(components_long %>% filter(!is.na(value)), 
       aes(x = date, y = value, color = component)) +
  geom_line(linewidth = 0.8) +
  facet_wrap(~ component, ncol = 2) +
  labs(
    title = "CFHI Components Over Time",
    subtitle = "All normalized to 0-100 scale (higher = better financial health)",
    x = "Date",
    y = "Normalized Value (0-100)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12, color = "gray40"),
    legend.position = "none"
  ) +
  scale_color_manual(values = c(
    "Savings Rate" = "#16a34a",
    "Wage Growth" = "#0891b2",
    "Inflation (inverted)" = "#ea580c",
    "Borrowing Rate (inverted)" = "#c026d3"
  ))
```

---

# Export Data

```{r export}
# Select and order columns for output
output_data <- cfhi_data %>%
  select(
    date, year, month,
    savings_rate, wage_level, wage_yoy, cpi_level, inflation_yoy, borrow_rate,
    S_star, W_star, I_star, R_star,
    CFHI_raw, CFHI
  )

# Write to CSV
write_csv(output_data, OUTPUT_FILE)

cat(sprintf("\n✓ Exported %d observations to: %s\n", nrow(output_data), OUTPUT_FILE))
cat(sprintf("  File size: %.2f KB\n", file.size(OUTPUT_FILE) / 1024))
```

---

# Data Preview

Interactive table of the final dataset:

```{r preview_table}
# Show last 50 rows (most recent data) in interactive table
output_data %>%
  tail(50) %>%
  arrange(desc(date)) %>%
  datatable(
    caption = "Most Recent CFHI Data (Last 50 Observations)",
    options = list(
      pageLength = 10,
      scrollX = TRUE,
      dom = 'Bfrtip'
    ),
    rownames = FALSE
  ) %>%
  formatRound(columns = c('savings_rate', 'wage_yoy', 'inflation_yoy', 'borrow_rate', 
                          'S_star', 'W_star', 'I_star', 'R_star', 'CFHI_raw', 'CFHI'), 
              digits = 2)
```

---

# Validation Checks

```{r validation}
cat("\n=== Data Quality Checks ===\n\n")

# Check for missing values
missing_counts <- output_data %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "missing_count") %>%
  filter(missing_count > 0)

if (nrow(missing_counts) > 0) {
  cat("⚠ Missing values detected:\n")
  print(missing_counts)
} else {
  cat("✓ No missing values in key variables\n")
}

# Check CFHI range
cat(sprintf("\n✓ CFHI range: %.2f to %.2f\n", 
            min(output_data$CFHI, na.rm = TRUE),
            max(output_data$CFHI, na.rm = TRUE)))

# Check component ranges
cat("\n✓ Component ranges (should be 0-100):\n")
cat(sprintf("  S_star: %.2f - %.2f\n", 
            min(output_data$S_star, na.rm = TRUE), 
            max(output_data$S_star, na.rm = TRUE)))
cat(sprintf("  W_star: %.2f - %.2f\n", 
            min(output_data$W_star, na.rm = TRUE), 
            max(output_data$W_star, na.rm = TRUE)))
cat(sprintf("  I_star: %.2f - %.2f\n", 
            min(output_data$I_star, na.rm = TRUE), 
            max(output_data$I_star, na.rm = TRUE)))
cat(sprintf("  R_star: %.2f - %.2f\n", 
            min(output_data$R_star, na.rm = TRUE), 
            max(output_data$R_star, na.rm = TRUE)))

cat("\n✓ Processing complete!\n")
```

---

# Session Information

```{r session_info}
sessionInfo()
```

---

# Notes for Future Researchers

## How to Use This File

1. **Update Input Data**: Modify the file paths in the Configuration section to point to your updated data sources
2. **Knit Document**: Click "Knit" in RStudio to run the entire pipeline and generate the HTML report
3. **Check Output**: The processed CFHI data will be saved to `cfhi_master_2000_onward.csv`

## Data Sources

All input data is sourced from U.S. government agencies:

- **Savings Rate**: Bureau of Economic Analysis (BEA) - Table 2.1
- **Wage Data**: Bureau of Labor Statistics (BLS) - Current Employment Statistics
- **Inflation (CPI)**: Bureau of Labor Statistics (BLS) - Consumer Price Index
- **Federal Funds Rate**: Federal Reserve Economic Data (FRED)

All source data is in the public domain and freely distributable.

## Citation

If using this methodology, please cite:

> Financial Health Analytics Dashboard. (2025). Consumer Financial Health Index (CFHI) Methodology and Data Processing Pipeline. Retrieved from [repository URL]

---

*Document generated on `r Sys.time()`*
